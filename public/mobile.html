
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bot Manager - Mobile</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
    .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; }
    .bot-card { touch-action: manipulation; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .status-dot.running { background: #10b981; box-shadow: 0 0 8px #10b981; }
    .status-dot.stopped { background: #6b7280; }
    .status-dot.deploying { background: #f59e0b; animation: pulse 1s infinite; }
    .status-dot.failed { background: #ef4444; }
    .status-dot.not-deployed { background: #9ca3af; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .console-line { font-family: monospace; font-size: 12px; }
    .console-line.error { color: #ef4444; }
    .console-line.success { color: #10b981; }
    .console-line.info { color: #3b82f6; }
  </style>
</head>
<body class="bg-gray-50 pb-16">
  
  <!-- Header -->
  <header class="bg-white border-b sticky top-0 z-40 px-4 py-3 shadow-sm">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <h1 class="text-lg font-bold text-gray-900">Bot Manager</h1>
      </div>
      <button id="addBotBtn" class="p-2 bg-blue-600 text-white rounded-lg active:bg-blue-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Bots View -->
  <div id="botsView" class="p-4">
    <div id="botsList" class="space-y-3">
      <div class="text-center py-12 text-gray-500">
        <div class="animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-3"></div>
        <p>Loading bots...</p>
      </div>
    </div>
  </div>

  <!-- Console View -->
  <div id="consoleView" class="hidden">
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between sticky top-14 z-30">
      <h2 class="font-semibold text-gray-900">Console</h2>
      <div class="flex gap-2">
        <button id="fetchLogsBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg active:bg-blue-700">
          Fetch Logs
        </button>
        <button id="clearConsoleBtn" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-lg active:bg-gray-300">
          Clear
        </button>
      </div>
    </div>
    <div id="consoleOutput" class="p-4 bg-gray-900 min-h-screen text-gray-100 text-sm"></div>
  </div>

  <!-- Settings View -->
  <div id="settingsView" class="hidden p-4">
    <div id="noSettings" class="text-center py-12 text-gray-500">
      <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
      <p>Select a bot to view settings</p>
    </div>
    
    <div id="settingsContent" class="hidden space-y-4">
      <h2 id="settingsBotName" class="text-xl font-bold mb-4"></h2>
      
      <div class="bg-white rounded-lg p-4 shadow-sm">
        <label class="block text-sm font-medium mb-2">Startup Command</label>
        <input type="text" id="startCommand" class="w-full border rounded-lg px-3 py-2.5 text-sm" placeholder="node index.js">
      </div>
      
      <div class="bg-white rounded-lg p-4 shadow-sm">
        <label class="block text-sm font-medium mb-2">Dependencies (JSON)</label>
        <textarea id="dependencies" rows="6" class="w-full border rounded-lg px-3 py-2.5 text-sm font-mono"></textarea>
      </div>
      
      <button id="saveSettingsBtn" class="w-full py-3 bg-blue-600 text-white font-medium rounded-lg active:bg-blue-700">
        Save Settings
      </button>
    </div>
  </div>

  <!-- Bottom Tab Bar -->
  <nav class="tab-bar bg-white border-t shadow-lg">
    <div class="flex">
      <button class="tab flex-1 py-3 flex flex-col items-center gap-1 text-blue-600 border-t-2 border-blue-600" data-view="bots">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <span class="text-xs font-medium">Bots</span>
      </button>
      <button class="tab flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-t-2 border-transparent" data-view="console">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <span class="text-xs font-medium">Console</span>
      </button>
      <button class="tab flex-1 py-3 flex flex-col items-center gap-1 text-gray-500 border-t-2 border-transparent" data-view="settings">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <span class="text-xs font-medium">Settings</span>
      </button>
    </div>
  </nav>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 items-center justify-center hidden z-50 px-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm slide-up">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">Modal</h3>
      <input type="text" id="modalInput" class="w-full border rounded-lg px-3 py-2.5 mb-4">
      <div class="flex gap-2">
        <button id="modalCancel" class="flex-1 py-2.5 bg-gray-200 text-gray-700 rounded-lg active:bg-gray-300">Cancel</button>
        <button id="modalConfirm" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg active:bg-blue-700">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Action Sheet -->
  <div id="actionSheet" class="fixed inset-0 bg-black/50 items-end justify-center hidden z-50" style="display: none;">
    <div class="bg-white rounded-t-xl w-full slide-up">
      <div class="p-4 border-b">
        <h3 id="actionSheetTitle" class="font-semibold text-lg"></h3>
      </div>
      <div id="actionSheetContent" class="p-4"></div>
    </div>
  </div>

  <script>
    const API_URL = '';
    let socket;
    let currentBot = null;
    let bots = [];
    let consoleLogs = [];

    function initSocket() {
      socket = io();
      socket.on('connect', () => console.log('Connected'));
      socket.on('log', addConsoleLog);
      socket.on('deploymentStatus', (data) => {
        const bot = bots.find(b => b.name === data.botName);
        if (bot) {
          bot.status = data.status;
          bot.progress = data.progress;
          renderBots();
          
          // Show toast notification when deployment completes
          if (data.status === 'running' && data.progress === 100) {
            showToast(`${data.botName} is now running!`, 'success');
          } else if (data.status === 'failed') {
            showToast(`${data.botName} deployment failed`, 'error');
          }
        }
      });
    }

    function addConsoleLog(data) {
      consoleLogs.push(data);
      if (consoleLogs.length > 200) consoleLogs.shift();
      
      const output = document.getElementById('consoleOutput');
      const line = document.createElement('div');
      line.className = `console-line ${data.type} py-1`;
      const time = new Date(data.timestamp).toLocaleTimeString();
      line.innerHTML = `<span class="text-gray-500">[${time}]</span> ${escapeHtml(data.message)}`;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadBots() {
      try {
        const res = await fetch(`${API_URL}/api/bots`);
        const data = await res.json();
        bots = data.bots || [];
        renderBots();
      } catch (err) {
        console.error('Failed to load bots:', err);
      }
    }

    function renderBots() {
      const list = document.getElementById('botsList');
      
      if (bots.length === 0) {
        list.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <p class="mb-2">No bots yet</p>
            <p class="text-sm">Tap + to create your first bot</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = bots.map(bot => `
        <div class="bot-card bg-white rounded-lg p-4 shadow-sm" data-bot="${bot.name}">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="status-dot ${bot.status}"></span>
              <div>
                <h3 class="font-semibold text-gray-900">${bot.name}</h3>
                <p class="text-xs text-gray-500 capitalize">${bot.status.replace('-', ' ')}</p>
              </div>
            </div>
            <button class="p-2" onclick="event.stopPropagation(); showBotActions('${bot.name}', '${bot.status}')">
              <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
              </svg>
            </button>
          </div>
          ${getQuickActions(bot)}
        </div>
      `).join('');
      
      list.querySelectorAll('.bot-card').forEach(el => {
        el.addEventListener('click', (e) => {
          if (!e.target.closest('button')) {
            selectBot(el.dataset.bot);
          }
        });
      });
    }

    function getQuickActions(bot) {
      const isDeploying = ['deploying', 'restarting', 'stopping'].includes(bot.status);
      
      if (isDeploying) {
        return `<div class="flex items-center gap-2 text-sm text-yellow-600"><div class="animate-spin w-4 h-4 border-2 border-yellow-600 border-t-transparent rounded-full"></div>${bot.status}...</div>`;
      }
      
      if (bot.status === 'running') {
        return `
          <div class="flex gap-2">
            <button onclick="event.stopPropagation(); restartBot('${bot.name}')" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium active:bg-blue-100">Restart</button>
            <button onclick="event.stopPropagation(); stopBot('${bot.name}')" class="flex-1 py-2 bg-orange-50 text-orange-600 rounded-lg text-sm font-medium active:bg-orange-100">Stop</button>
          </div>
        `;
      }
      
      return `
        <div class="flex gap-2">
          <button onclick="event.stopPropagation(); deployBot('${bot.name}')" class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-sm font-medium active:bg-green-100">Deploy</button>
          <button onclick="event.stopPropagation(); deleteBot('${bot.name}')" class="flex-1 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium active:bg-red-100">Delete</button>
        </div>
      `;
    }

    function showBotActions(botName, status) {
      const sheet = document.getElementById('actionSheet');
      const title = document.getElementById('actionSheetTitle');
      const content = document.getElementById('actionSheetContent');
      
      title.textContent = botName;
      content.innerHTML = `
        <button onclick="selectBot('${botName}'); hideActionSheet()" class="w-full py-3 text-left border-b">View Settings</button>
        ${status === 'running' ? `
          <button onclick="restartBot('${botName}'); hideActionSheet()" class="w-full py-3 text-left text-blue-600 border-b">Restart Bot</button>
          <button onclick="stopBot('${botName}'); hideActionSheet()" class="w-full py-3 text-left text-orange-600 border-b">Stop Bot</button>
        ` : `
          <button onclick="deployBot('${botName}'); hideActionSheet()" class="w-full py-3 text-left text-green-600 border-b">Deploy Bot</button>
        `}
        <button onclick="deleteBot('${botName}'); hideActionSheet()" class="w-full py-3 text-left text-red-600">Delete Bot</button>
        <button onclick="hideActionSheet()" class="w-full py-3 text-left text-gray-500 mt-2 border-t">Cancel</button>
      `;
      
      sheet.style.display = 'flex';
    }

    function hideActionSheet() {
      document.getElementById('actionSheet').style.display = 'none';
    }

    async function selectBot(botName) {
      currentBot = botName;
      await loadSettings();
      switchView('settings');
    }

    async function loadSettings() {
      if (!currentBot) return;
      
      try {
        const res = await fetch(`${API_URL}/api/bots/${currentBot}/config`);
        const data = await res.json();
        
        document.getElementById('noSettings').style.display = 'none';
        document.getElementById('settingsContent').style.display = 'block';
        document.getElementById('settingsBotName').textContent = currentBot;
        
        document.getElementById('startCommand').value = data.config.startCommand || 'node index.js';
        document.getElementById('dependencies').value = JSON.stringify(data.config.dependencies || {}, null, 2);
      } catch (err) {
        console.error('Failed to load settings:', err);
      }
    }

    async function saveSettings() {
      if (!currentBot) return;
      
      try {
        let deps = {};
        try { deps = JSON.parse(document.getElementById('dependencies').value); } catch {}
        
        await fetch(`${API_URL}/api/bots/${currentBot}/config`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            startCommand: document.getElementById('startCommand').value,
            dependencies: deps
          })
        });
        
        showToast('Settings saved', 'success');
      } catch (err) {
        showToast('Failed to save', 'error');
      }
    }

    async function deployBot(name) {
      try {
        await fetch(`${API_URL}/api/deploy/${name}`, { method: 'POST' });
        showToast('Deployment started', 'success');
      } catch (err) {
        showToast('Deploy failed', 'error');
      }
    }

    async function stopBot(name) {
      try {
        await fetch(`${API_URL}/api/stop/${name}`, { method: 'POST' });
      } catch (err) {
        showToast('Stop failed', 'error');
      }
    }

    async function restartBot(name) {
      try {
        await fetch(`${API_URL}/api/restart/${name}`, { method: 'POST' });
      } catch (err) {
        showToast('Restart failed', 'error');
      }
    }

    async function deleteBot(name) {
      if (!confirm(`Delete ${name}?`)) return;
      
      try {
        await fetch(`${API_URL}/api/delete/${name}`, { method: 'DELETE' });
        loadBots();
        showToast('Bot deleted', 'success');
      } catch (err) {
        showToast('Delete failed', 'error');
      }
    }

    async function createBot() {
      const name = await showModal('Create Bot', 'Enter bot name:');
      if (!name) return;
      
      try {
        await fetch(`${API_URL}/api/bots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        
        await loadBots();
        showToast('Bot created', 'success');
      } catch (err) {
        showToast('Create failed', 'error');
      }
    }

    function switchView(view) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('text-blue-600', 'border-blue-600');
        t.classList.add('text-gray-500', 'border-transparent');
      });
      
      const tab = document.querySelector(`[data-view="${view}"]`);
      tab.classList.add('text-blue-600', 'border-blue-600');
      tab.classList.remove('text-gray-500', 'border-transparent');
      
      document.getElementById('botsView').classList.toggle('hidden', view !== 'bots');
      document.getElementById('consoleView').classList.toggle('hidden', view !== 'console');
      document.getElementById('settingsView').classList.toggle('hidden', view !== 'settings');
    }

    async function fetchCloudLogs() {
      if (!currentBot) {
        showToast('Select a bot first', 'error');
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/api/logs/${currentBot}`);
        const data = await res.json();
        
        if (data.logs && data.logs.length > 0) {
          const output = document.getElementById('consoleOutput');
          output.innerHTML += '<div class="console-line text-gray-400 border-t border-gray-700 mt-2 pt-2">--- Cloud Logs ---</div>';
          data.logs.forEach(log => {
            const line = document.createElement('div');
            line.className = 'console-line py-1';
            line.textContent = log;
            output.appendChild(line);
          });
          output.scrollTop = output.scrollHeight;
        }
      } catch (err) {
        showToast('Failed to fetch logs', 'error');
      }
    }

    function showModal(title, placeholder) {
      return new Promise((resolve) => {
        const modal = document.getElementById('modal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalInput').placeholder = placeholder;
        document.getElementById('modalInput').value = '';
        modal.style.display = 'flex';
        document.getElementById('modalInput').focus();
        
        const cleanup = () => { modal.style.display = 'none'; };
        
        document.getElementById('modalCancel').onclick = () => {
          cleanup();
          resolve(null);
        };
        
        document.getElementById('modalConfirm').onclick = () => {
          const value = document.getElementById('modalInput').value.trim();
          cleanup();
          resolve(value || null);
        };
      });
    }

    function showToast(message, type = 'info') {
      const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
      const toast = document.createElement('div');
      toast.className = `fixed top-4 left-4 right-4 px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg z-50 slide-up`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchView(tab.dataset.view));
    });

    document.getElementById('addBotBtn').addEventListener('click', createBot);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('fetchLogsBtn').addEventListener('click', fetchCloudLogs);
    document.getElementById('clearConsoleBtn').addEventListener('click', () => {
      document.getElementById('consoleOutput').innerHTML = '';
      consoleLogs = [];
    });

    document.getElementById('actionSheet').addEventListener('click', (e) => {
      if (e.target.id === 'actionSheet') hideActionSheet();
    });

    initSocket();
    loadBots();
  </script>
</body>
</html>
